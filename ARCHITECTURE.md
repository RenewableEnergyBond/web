# Infrastructure Architecture

*Last updated: October 15, 2025*

## Overview

**rebond.eco** uses a full-stack Cloudflare architecture for optimal performance and enhanced security.

```mermaid
flowchart LR
    %% Styles
    classDef ext fill:#eee,stroke:#bbb,stroke-width:1px,color:#333
    classDef dns fill:#f3f3ff,stroke:#8a8aff,stroke-width:1px
    classDef edge fill:#e9fff0,stroke:#34c759,stroke-width:1px
    classDef svc fill:#f7faff,stroke:#7aa7ff,stroke-width:1px
    classDef mail fill:#fff0f6,stroke:#ff84b4,stroke-width:1px

    %% User
    U[User<br/><small>Browser</small>]:::ext

    %% DNS (Cloudflare authority)
    CF_NS[(Cloudflare DNS<br/><small>Zone & Records</small>)]:::dns

    %% Edge / Frontend / API
    CF_Edge[(Cloudflare Edge<br/><small>CDN / WAF / Cache</small>)]:::edge
    CF_Pages[Cloudflare Pages<br/><small>Frontend</small>]:::svc
    CF_Worker[Worker /api/paperboy<br/><small>Contact Endpoint</small>]:::edge

    %% Email (relay)
    BREVO[(Brevo<br/><small>SMTP Relay</small>)]:::mail

    %% DNS Records
    CF_NS -. A/AAAA/CNAME .-> CF_Edge
    CF_NS -. SPF/DKIM/DMARC (Brevo) .-> BREVO

    %% User Traffic
    U -->|HTTPS| CF_Edge --> CF_Pages
    CF_Pages -->|Fetch /api/paperboy| CF_Worker

    %% Email Sending
    CF_Worker -. SMTP/API .-> BREVO

    %% Styling
    class U ext
```

## Cloudflare Services

### DNS Management
- **DNS Zone**: Complete DNS record management for `rebond.eco`
- **Email Records**: SPF/DKIM/DMARC configuration for Brevo authentication
- **Security**: Native DDoS protection and Web Application Firewall (WAF)

### Cloudflare Pages
- **Static Hosting**: Files generated by Vite SSG (`dist/`)
- **Automatic Deployment**: GitHub integration with build on push
- **Global CDN**: Worldwide distribution with intelligent caching
- **Configuration**: Defined in `wrangler.toml`

### Cloudflare Functions
- **Runtime**: V8 Workers for serverless endpoints
- **Main Endpoint**: `/api/paperboy` for contact form processing
- **Security**: Integrated Turnstile validation
- **Performance**: Edge computing execution

## Detailed Data Flows

### 1. User Navigation
```
User → Cloudflare Edge → Cache/CDN → Pages (Vue.js SSG)
```
- Intelligent caching of static assets
- Automatic Brotli/Gzip compression
- Resource minification

### 2. Contact Form Processing
```mermaid
sequenceDiagram
    participant U as User
    participant CF as Cloudflare Edge
    participant P as Pages (Frontend)
    participant W as Worker (/api/paperboy)
    participant T as Turnstile
    participant B as Brevo API

    U->>P: Fill form
    P->>T: Request CAPTCHA token
    T-->>P: Turnstile token
    U->>CF: POST /api/paperboy + data
    CF->>W: Execute function
    W->>T: Validate token
    T-->>W: Validation OK/Failed
    W->>B: Send email (if valid)
    B-->>W: Send confirmation
    W-->>U: JSON response (success/error)
```

### 3. Build and Deployment
```
GitHub Push → Cloudflare Pages → Build (yarn build-ssg) → Deploy → CDN Refresh
```

## Configuration & Variables

### Public Variables (`wrangler.toml`)
```toml
[vars]
VITE_TURNSTILE_SITE_KEY = "0x4AAAAAAB6ZpXuSNzkjmZMQ"
```

### Secrets (managed via Wrangler CLI)
```bash
# Secret keys configuration
wrangler secret put BREVO_API_KEY
wrangler secret put TURNSTILE_SECRET_KEY
```

### Build Environment Variables
- `BASE_PATH`: Base path for assets (default: `/`)
- `VITE_*`: Variables exposed to frontend via Vite

## External Services

### Brevo (formerly SendinBlue)
- **Usage**: SMTP service for email delivery
- **API**: REST API v3 (`https://api.brevo.com/v3/smtp/email`)
- **Authentication**: API Key stored in Cloudflare secrets
- **DNS Configuration**: SPF, DKIM, DMARC records for deliverability

### Turnstile (Cloudflare CAPTCHA)
- **Usage**: Anti-bot protection for forms
- **Integration**: Frontend widget + backend validation
- **Advantage**: GDPR-friendly alternative to reCAPTCHA
- **Performance**: Native Cloudflare validation with no external latency

## Security

### DDoS Protection
- Automatic mitigation via Cloudflare Edge
- Configurable rate limiting per endpoint
- Geo-blocking available if needed

### Form Validation
- **Frontend**: Client-side TypeScript validation
- **Backend**: Re-validation + sanitization in Worker
- **Anti-spam**: Mandatory Turnstile CAPTCHA
- **CORS**: Headers configured for authorized domains

### Secrets Management
- Secrets stored in Cloudflare (encrypted)
- Rotation possible via Wrangler CLI
- No keys exposed in source code

## Monitoring & Logs

### Cloudflare Analytics
- Traffic and performance metrics
- Request and error logs
- Automatic uptime monitoring

### Debugging
```bash
# Real-time Worker logs
wrangler tail

# Local Functions testing
wrangler dev --local
```
